version: "3.8"
services:
  silverstripe:
    # image: brettt89/silverstripe-web:8.0-apache
    image: silverstripe:refined
    ports:
      - 8080:80
    volumes:
      - ./docker/config/php/74/custom.php.ini:/usr/local/etc/php/conf.d/custom.php.ini:cached
      - .:/var/www/html:cached
      # using local composer cache to save a bit of bandwidth - depending on your hostplattform you need to adapt paths
      # Defaults to C:\Users\<user>\AppData\Local\Composer on Windows,
      # /Users/<user>/Library/Caches/composer on macOS,
      # $XDG_CACHE_HOME/composer on unix systems that follow the XDG Base Directory Specifications,
      # and $COMPOSER_HOME/cache on other unix systems. Stores all the caches used by Composer.
      - ~/.composer:/root/.composer:delegated
      - /run/host-services/ssh-auth.sock:/run/host-services/ssh-auth.sock
      - ./docker/log/apache2/access.log:/var/log/apache2/access.log:delegated
      - ./docker/log/apache2/error.log:/var/log/apache2/error.log:delegated
      - ./docker/log/apache2/other_vhosts_access.log:/var/log/apache2/other_vhosts_access.log:delegated
      # - type: bind
      #   source: ./docker/log/apache2/access.log
      #   target: /var/log/apache2/access.log
      # - type: bind
      #   source: ./docker/log/apache2/error.log
      #   target: /var/log/apache2/error.log
      # - type: bind
      #   source: ./docker/log/apache2/other_vhosts_access.log
      #   target: /var/log/apache2/other_vhosts_access.log
    depends_on:
      - database
      - mailhog
    environment:
      - SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock
      - DOCUMENT_ROOT=/var/www/html/public
      - SS_TRUSTED_PROXY_IPS=*
      - SS_ENVIRONMENT_TYPE=dev
      - SS_DATABASE_SERVER=database
      - SS_DATABASE_NAME=database
      # - SS_DATABASE_SERVER=host.docker.internal
      # - SS_DATABASE_NAME=SS_project
      - SS_DATABASE_USERNAME=root
      - SS_DATABASE_PASSWORD=
      - SS_DEFAULT_ADMIN_USERNAME=admin
      - SS_DEFAULT_ADMIN_PASSWORD=password
      - SS_ERROR_LOG=silverstripe.log
      - GHOSTSCRIPT_PATH=/usr/bin/gs
    extra_hosts:
      - "host.docker.internal:host-gateway"

  database:
    image: mysql:5.7
    environment:
      - MYSQL_ALLOW_EMPTY_PASSWORD=yes
    volumes:
      - ./docker/data/mysql/:/var/lib/mysql:delegated
      - ./docker/config/mysql/my.cnf:/etc/mysql/conf.d/z_my.cnf

  pma:
    image: phpmyadmin/phpmyadmin
    restart: always
    links:
        - database
    ports:
        - 8081:80
    environment:
        - PMA_ARBITRARY=1
        - PMA_PORT=3306
        - PMA_HOST=database
        - PMA_USER=root
        - PMA_PASSWORD=
        - UPLOAD_LIMIT=300M

  mailhog:
    image: mailhog/mailhog:latest
    # container_name: '${COMPOSE_PROJECT_NAME}-mailhog'
    ports:
      - 1025:1025
      - 8025:8025
    # networks:
    #   - mailhog

# volumes:
#      db-data:
